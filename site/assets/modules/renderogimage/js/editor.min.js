"use strict";const application=function(t){let e,n,i=0,l={images:[],defaultImages:[],text:null,filterLayer:[]},o=null,a=t.bgcolor,s=t.fontfamily,u=t.fontweight,f=t.linewidth;function r(t){let e;if(e=document.querySelector(t))return e;throw"Невыбран элемент: "+t}function c(t){let e=1144/t.width;e<1?n.drawImage(t.image,t.x,t.y,t.width*e,t.height*e):n.drawImage(t.image,t.x,t.y,t.width,t.height)}function h(){n.fillStyle=a,n.fillRect(0,0,1144,643),l.images.length>0&&l.images.forEach(t=>{c(t)}),n.fillStyle=l.filterLayer.color,n.globalAlpha=l.filterLayer.alpha,n.fillRect(0,0,1144,643),n.globalAlpha=1,l.text&&function(t){let e=function(t,e){let n=t.split(/\r\n|\n/g),i=[];n[0];for(var l=0;l<n.length;l++)n[l],i.push(n[l]);return i}(t.txt),i=0,o=t.y,a=[],s=[],u=0;e.forEach(e=>{n.font=t.fontweight+" "+t.fonsize+"px "+t.fontfamily,i+=1.2*parseInt(t.fonsize),n.textAlign="left",n.fillStyle=t.textcolor;let l=parseInt(n.measureText(e).width),f=572-l/2;u+=i,a.push(parseInt(f)),s.push(572+l/2),n.lineWidth=t.linewidth,n.miterLimit=3,n.lineJoin="circle",n.strokeStyle=t.textoutline,n.strokeText(e,f,o+i),n.lineWidth=0,n.fillText(e,f,o+i)});let f=a.sort(function(t,e){return t-e}),r=s.sort(function(t,e){return t-e});l.text.x=f[0],l.text.width=r[0],l.text.height=u}(l.text),l.defaultImages.length>0&&l.defaultImages.forEach(t=>{c(t)})}function d(t){let e=event.layerX,n=event.layerY,i=t.x,l=t.y,o=t.x+t.width,a=t.y+t.height;return e>=i&&e<=o&&n>=l&&n<=a}function p(){n.clearRect(0,0,1144,643),e.onmousemove=function(t){o&&(o.x=t.layerX-o.pressX,o.y=t.layerY-o.pressY)},h(),requestAnimationFrame(p)}this.start=function(){(e=r(t.canvas)).width=t.width||1144,e.height=t.height||509,n=e.getContext("2d"),r(".image_src_input").addEventListener("change",function(t){if(console.log(t.target.files),t.target.files.length>0){let e=window.webkitURL||window.URL,n=new Image;n.src=e.createObjectURL(t.target.files[0]);let i=[];i.image=n,i.x=0,i.y=0,i.pressX=0,i.pressY=0,n.onload=function(){i.width=n.width,i.height=n.height,l.images[0]=i}}}),r(".btn_loadimage").addEventListener("click",function(){r(".image_src_input").click()}),r(".input_select_bgcolor").addEventListener("input",function(t){a=this.value}),r(".post_text").addEventListener("input",function(){l.text.txt=this.value}),r(".input_select_textcolor").addEventListener("input",function(){l.text.textcolor=this.value}),r(".input_select_textoutline").addEventListener("input",function(){l.text.textoutline=this.value}),r(".input_select_linewidth").addEventListener("input",function(){l.text.linewidth=this.value}),r(".input_fontsize").addEventListener("change",function(){l.text.fonsize=this.value}),r(".input_overlay_alpha").addEventListener("input",function(){l.filterLayer.alpha=this.value}),r(".input_select_fontweight").addEventListener("input",function(){l.text.fontweight=this.value}),r(".input_select_font_family").addEventListener("input",function(){l.text.fontfamily=this.value}),t.fonts.length>0&&t.fonts.forEach(t=>{new FontFace(t.name,t.url,{style:t.style,weight:t.weight}).load().then(function(e){let n;document.fonts.add(e),![...r(".input_select_font_family").querySelectorAll("option")].find(e=>e.value==t.name)&&((n=document.createElement("option")).textContent=n.value=t.name,r(".input_select_font_family").append(n),r(".input_select_font_family").value=s)})});let i=[],c=[];i.txt=r(".post_text").value="Текст и лого\nможно двигать",i.x=0,i.y=e.height/2-75,i.pressX=0,i.pressY=0,a=r(".input_select_bgcolor").value=a||"#000000",i.fontfamily=r(".input_select_font_family").value=s=t.fontfamily||"Calibri",i.fontweight=r(".input_select_fontweight").value=u=t.fontweight||"normal",i.linewidth=r(".input_select_linewidth").value=f=t.linewidth||"4",i.fonsize=r(".input_fontsize").value="48",i.textoutline=r(".input_select_textoutline").value="#000000",i.textcolor=r(".input_select_textcolor").value="#FFFFFF",c.alpha=r(".input_overlay_alpha").value="0.2",c.color=a,l.text=i,l.filterLayer=c,p(),e.onmouseup=function(){o=null},e.onmousedown=function(t){l.images.forEach(e=>{d(e)&&((o=e).pressX=t.offsetX-e.x,o.pressY=t.offsetY-e.y)}),l.defaultImages.forEach(e=>{d(e)&&((o=e).pressX=t.offsetX-e.x,o.pressY=t.offsetY-e.y)}),d(l.text)&&((o=l.text).pressX=t.offsetX-l.text.x,o.pressY=t.offsetY-l.text.y)}},r(".download").addEventListener("click",function(t){let n=("0000"+ ++i).slice(-4),l=e.toDataURL("image/jpeg"),o=document.createElement("a");o.href=l,o.download="poster-"+n+".jpg",o.target="_blank",o.click(),o.remove()})};