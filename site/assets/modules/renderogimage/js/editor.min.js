"use strict";const application=function(t){let e,n,i=0,l={images:[],defaultImages:[],text:null,filterLayer:[]},o=null,a=t.bgcolor,s=t.fontfamily,f=t.fontweight,r=t.linewidth;function u(t){let e;if(e=document.querySelector(t))return e;throw"Невыбран элемент: "+t}function h(t){let i=e.width/t.width;i<1?n.drawImage(t.image,t.x,t.y,t.width*i,t.height*i):n.drawImage(t.image,t.x,t.y,t.width,t.height)}function c(){n.fillStyle=a,n.fillRect(0,0,e.width,e.height),l.images.length>0&&l.images.forEach(t=>{h(t)}),n.fillStyle=l.filterLayer.color,n.globalAlpha=l.filterLayer.alpha,n.fillRect(0,0,e.width,e.height),n.globalAlpha=1,l.text&&function(t){let i=function(t,e){let n=t.split(/\r\n|\n/g),i=[];n[0];for(var l=0;l<n.length;l++)n[l],i.push(n[l]);return i}(t.txt,e.width),o=0,a=t.y,s=[],f=[],r=0;i.forEach(i=>{n.font=t.fontweight+" "+t.fonsize+"px "+t.fontfamily,o+=1.2*parseInt(t.fonsize),n.textAlign="left",n.fillStyle=t.textcolor;let l=parseInt(n.measureText(i).width),u=e.width/2-l/2;r+=o,s.push(parseInt(u)),f.push(e.width/2+l/2),n.lineWidth=t.linewidth,n.miterLimit=3,n.lineJoin="circle",n.strokeStyle=t.textoutline,n.strokeText(i,u,a+o),n.lineWidth=0,n.fillText(i,u,a+o)});let u=s.sort(function(t,e){return t-e}),h=f.sort(function(t,e){return t-e});l.text.x=u[0],l.text.width=h[0],l.text.height=r}(l.text),l.defaultImages.length>0&&l.defaultImages.forEach(t=>{h(t)})}function d(t){let e=event.layerX,n=event.layerY,i=t.x,l=t.y,o=t.x+t.width,a=t.y+t.height;return e>=i&&e<=o&&n>=l&&n<=a}function p(){n.clearRect(0,0,e.width,e.height),e.onmousemove=function(t){o&&(o.x=t.layerX-o.pressX,o.y=t.layerY-o.pressY)},c(),requestAnimationFrame(p)}this.start=function(){(e=u(t.canvas)).width=e.offsetWidth,e.height=e.offsetHeight,n=e.getContext("2d"),u(".image_src_input").addEventListener("change",function(t){if(console.log(t.target.files),t.target.files.length>0){let e=window.webkitURL||window.URL,n=new Image;n.src=e.createObjectURL(t.target.files[0]);let i=[];i.image=n,i.x=0,i.y=0,i.pressX=0,i.pressY=0,n.onload=function(){i.width=n.width,i.height=n.height,l.images[0]=i}}}),u(".btn_loadimage").addEventListener("click",function(){u(".image_src_input").click()}),u(".input_select_bgcolor").addEventListener("input",function(t){a=this.value}),u(".post_text").addEventListener("input",function(){l.text.txt=this.value}),u(".input_select_textcolor").addEventListener("input",function(){l.text.textcolor=this.value}),u(".input_select_textoutline").addEventListener("input",function(){l.text.textoutline=this.value}),u(".input_select_linewidth").addEventListener("input",function(){l.text.linewidth=this.value}),u(".input_fontsize").addEventListener("change",function(){l.text.fonsize=this.value}),u(".input_overlay_alpha").addEventListener("input",function(){l.filterLayer.alpha=this.value}),u(".input_select_fontweight").addEventListener("input",function(){l.text.fontweight=this.value}),u(".input_select_font_family").addEventListener("input",function(){l.text.fontfamily=this.value}),t.fonts.length>0&&t.fonts.forEach(t=>{new FontFace(t.name,t.url,{style:t.style,weight:t.weight}).load().then(function(e){let n;document.fonts.add(e),![...u(".input_select_font_family").querySelectorAll("option")].find(e=>e.value==t.name)&&((n=document.createElement("option")).textContent=n.value=t.name,u(".input_select_font_family").append(n),u(".input_select_font_family").value=s)})});let i=[];i.txt=u(".post_text").value,i.x=0,i.y=e.height/2-15,i.pressX=0,i.pressY=0,i.linewidth=r,i.textcolor="#fff",i.textoutline="#000",i.fonsize="26",i.fontfamily=s,i.fontweight=f,l.text=i;let h=[];h.alpha=.2,h.color="#000000",l.filterLayer=h,p(),e.onmouseup=function(){o=null},e.onmousedown=function(t){l.images.forEach(e=>{d(e)&&((o=e).pressX=t.offsetX-e.x,o.pressY=t.offsetY-e.y)}),l.defaultImages.forEach(e=>{d(e)&&((o=e).pressX=t.offsetX-e.x,o.pressY=t.offsetY-e.y)}),d(l.text)&&((o=l.text).pressX=t.offsetX-l.text.x,o.pressY=t.offsetY-l.text.y)}},u(".download").addEventListener("click",function(t){let n=("0000"+ ++i).slice(-4),l=e.toDataURL("image/jpeg"),o=document.createElement("a");o.href=l,o.download="poster-"+n+".jpg",o.click(),o.remove()})};